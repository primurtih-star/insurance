{% extends "layout.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- 1. THEME VARIABLES & GLOBAL --- */
    :root {
        --font-main: 'Plus Jakarta Sans', sans-serif;
        
        /* Modern Medical Palette */
        --primary: #059669;        /* Emerald 600 */
        --primary-light: #10b981;  /* Emerald 500 */
        --primary-bg: #ecfdf5;     /* Emerald 50 */
        
        --accent: #3b82f6;         /* Blue 500 */
        --accent-bg: #eff6ff;      /* Blue 50 */
        
        --danger: #ef4444;
        --danger-bg: #fef2f2;

        --text-dark: #1e293b;      /* Slate 800 */
        --text-muted: #64748b;     /* Slate 500 */
        --border-color: #e2e8f0;   /* Slate 200 */
        
        --glass-bg: rgba(255, 255, 255, 0.92);
        --glass-border: rgba(255, 255, 255, 0.6);
        --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
        --shadow-glow: 0 20px 40px -5px rgba(16, 185, 129, 0.25);
    }

    * { box-sizing: border-box; }

    body {
        font-family: var(--font-main);
        color: var(--text-dark);
    }

    /* Layout Wrapper */
    .lab-container {
        min-height: 100vh;
        width: 100%;
        background: radial-gradient(circle at top left, #f0fdf4, #f8fafc);
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        overflow-x: hidden;
    }

    /* Canvas Background */
    #form-canvas {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 0; pointer-events: none; opacity: 0.6;
    }

    /* --- 2. MAIN CARD (Glassmorphism) --- */
    .split-card {
        display: grid;
        grid-template-columns: 0.8fr 1.2fr;
        width: 100%;
        max-width: 1050px;
        background: var(--glass-bg);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid var(--glass-border);
        border-radius: 32px;
        box-shadow: var(--shadow-glow), var(--shadow-soft);
        overflow: hidden;
        z-index: 10;
        position: relative;
        transition: transform 0.3s ease;
    }

    /* --- LEFT SIDE: VISUAL BRANDING --- */
    .visual-side {
        background: linear-gradient(145deg, var(--primary) 0%, #047857 100%);
        padding: 60px 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        color: white;
        position: relative;
        overflow: hidden;
    }

    /* Decorative Blobs */
    .blob {
        position: absolute; border-radius: 50%;
        background: rgba(255,255,255,0.15);
        filter: blur(40px);
    }
    .blob-1 { width: 300px; height: 300px; top: -100px; left: -100px; }
    .blob-2 { width: 200px; height: 200px; bottom: -50px; right: -50px; }

    /* 3D Clipboard Animation */
    .clipboard-wrapper {
        width: 100%; height: 240px;
        position: relative;
        display: flex; justify-content: center; align-items: center;
        perspective: 1200px;
        margin-bottom: 40px;
        z-index: 2;
    }

    .clipboard-3d {
        width: 140px; height: 190px;
        background: #fff;
        border-radius: 16px;
        position: relative;
        transform-style: preserve-3d;
        transform: rotateY(-15deg) rotateX(10deg);
        box-shadow: 25px 25px 40px rgba(0,0,0,0.15);
        animation: floatBoard 5s ease-in-out infinite;
    }

    .clipboard-3d::after { /* Thickness */
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        border-radius: 16px; background: #e2e8f0;
        transform: translateZ(-5px);
    }

    .clip-top {
        position: absolute; top: -8px; left: 50%; transform: translateX(-50%) translateZ(2px);
        width: 70px; height: 25px;
        background: #64748b; border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .paper-lines {
        position: absolute; top: 35px; left: 20px; right: 20px;
        height: 6px; background: #f1f5f9; border-radius: 3px;
        box-shadow: 0 15px 0 #f1f5f9, 0 30px 0 #f1f5f9, 0 45px 0 #f1f5f9;
    }

    .check-icon {
        position: absolute; bottom: 25px; right: 15px;
        font-size: 2.5rem; color: var(--primary);
        filter: drop-shadow(0 4px 8px rgba(16, 185, 129, 0.2));
        transform: translateZ(10px);
    }

    .side-content { position: relative; z-index: 2; }
    .side-title { 
        font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 16px; 
        letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .side-desc { font-size: 1.05rem; opacity: 0.9; line-height: 1.6; font-weight: 500; }

    /* --- RIGHT SIDE: FORM --- */
    .form-side {
        padding: 50px;
        overflow-y: auto;
    }

    .section-head {
        display: flex; align-items: center; gap: 12px;
        margin-bottom: 24px; 
    }
    .sec-badge {
        background: var(--primary-bg); color: var(--primary);
        width: 40px; height: 40px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.1);
    }
    .sec-title { 
        font-size: 1.1rem; font-weight: 700; color: var(--text-dark); 
        letter-spacing: -0.3px;
    }
    .divider { height: 1px; background: var(--border-color); margin: 30px 0; border: none; }

    /* Inputs */
    .input-group { margin-bottom: 20px; }
    .input-group label {
        display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-dark);
        margin-bottom: 8px; margin-left: 4px;
    }

    .field-wrapper { position: relative; }
    .field-wrapper i {
        position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
        color: #94a3b8; font-size: 1.1rem; transition: 0.3s;
        pointer-events: none;
    }

    .form-input {
        width: 100%; padding: 14px 16px 14px 48px;
        border: 2px solid #f1f5f9; border-radius: 14px;
        background: #f8fafc; font-size: 0.95rem; color: var(--text-dark);
        font-weight: 500; font-family: inherit;
        transition: all 0.2s ease;
    }
    
    .form-input::placeholder { color: #cbd5e1; font-weight: 400; }

    .form-input:hover { background: #fff; border-color: #cbd5e1; }
    .form-input:focus {
        background: #fff; border-color: var(--primary-light);
        outline: none;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
    .form-input:focus + i { color: var(--primary); }

    /* Custom Select Arrow */
    select.form-input {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
    }

    /* Gender Selection Cards */
    .gender-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .gender-radio { display: none; }

    .gender-box {
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
        padding: 16px; border: 2px solid #f1f5f9; border-radius: 14px;
        cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fff; color: var(--text-muted);
    }
    .gender-box i { font-size: 1.8rem; transition: 0.3s; margin-bottom: 5px; }
    .gender-box span { font-weight: 600; font-size: 0.9rem; }

    .gender-box:hover { border-color: #cbd5e1; transform: translateY(-2px); }

    /* Active States Gender */
    input[value="male"]:checked + .gender-box {
        border-color: var(--accent); background: var(--accent-bg); color: var(--accent);
        box-shadow: 0 8px 15px -5px rgba(59, 130, 246, 0.3);
    }
    input[value="female"]:checked + .gender-box {
        border-color: #ec4899; background: #fdf2f8; color: #ec4899;
        box-shadow: 0 8px 15px -5px rgba(236, 72, 153, 0.3);
    }

    /* Smoker Toggle Redesigned */
    .toggle-wrapper {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--danger-bg); padding: 16px 20px; 
        border-radius: 16px; border: 1px solid #fee2e2;
        transition: 0.3s;
    }
    .toggle-info { display: flex; align-items: center; gap: 12px; color: var(--danger); font-weight: 700; font-size: 0.95rem; }
    .toggle-info i { font-size: 1.2rem; }
    
    .switch { position: relative; display: inline-block; width: 52px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { 
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
        background-color: #e2e8f0; transition: .4s; border-radius: 34px; 
    }
    .slider:before { 
        position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; 
        background-color: white; transition: .4s; border-radius: 50%; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    input:checked + .slider { background-color: var(--danger); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* Buttons */
    .action-row {
        display: flex; justify-content: space-between; align-items: center; margin-top: 35px;
    }
    
    .btn-main {
        padding: 14px 28px; 
        background: var(--primary); color: white;
        border: none; border-radius: 12px; 
        font-weight: 700; font-size: 0.95rem; cursor: pointer;
        display: flex; align-items: center; gap: 10px; 
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    .btn-main:hover { 
        background: var(--primary-light); 
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
    }
    .btn-main:active { transform: translateY(-1px); }
    
    .btn-secondary {
        background: #3b82f6; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }
    .btn-secondary:hover { background: #60a5fa; box-shadow: 0 12px 25px rgba(59, 130, 246, 0.4); }

    .btn-reset {
        padding: 10px 15px; background: transparent; color: var(--text-muted);
        border: none; font-weight: 600; cursor: pointer; border-radius: 8px;
        transition: 0.2s;
    }
    .btn-reset:hover { background: #f1f5f9; color: var(--text-dark); }

    /* Animation */
    @keyframes floatBoard { 
        0%, 100% { transform: rotateY(-15deg) rotateX(10deg) translateY(0); } 
        50% { transform: rotateY(-10deg) rotateX(5deg) translateY(-12px); } 
    }

    /* Responsive */
    @media (max-width: 960px) {
        .split-card { grid-template-columns: 1fr; max-width: 550px; }
        .visual-side { padding: 40px 30px; text-align: center; }
        .clipboard-wrapper { display: none; } /* Hide on mobile/tablet */
        .blob { display: none; }
        .side-title { font-size: 2rem; }
    }
</style>

<div class="lab-container">
    
    <canvas id="form-canvas"></canvas>

    <div class="split-card">
        
        <div class="visual-side">
            <div class="blob blob-1"></div>
            <div class="blob blob-2"></div>

            <div class="clipboard-wrapper">
                <div class="clipboard-3d">
                    <div class="clip-top"></div>
                    <div class="paper-lines"></div>
                    <i class="fas fa-check-circle check-icon"></i>
                </div>
            </div>
            
            <div class="side-content">
                <h1 class="side-title">Patient<br>Registration</h1>
                <p class="side-desc">
                    Sistem input data klinis presisi berbasis AI untuk kalkulasi premi asuransi yang akurat dan efisien.
                </p>
            </div>
        </div>

        <div class="form-side">
            <form id="patientForm" onsubmit="return false;">
                
                <div class="section-head">
                    <div class="sec-badge"><i class="fas fa-user-circle"></i></div>
                    <span class="sec-title">Data Personal</span>
                </div>

                <div class="input-group">
                    <label>Nama Lengkap (Opsional)</label>
                    <div class="field-wrapper">
                        <input type="text" id="name" class="form-input" placeholder="Contoh: Budi Santoso">
                        <i class="fas fa-signature"></i>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label>Usia (Tahun)</label>
                        <div class="field-wrapper">
                            <input type="number" id="age" class="form-input" placeholder="0">
                            <i class="fas fa-birthday-cake"></i>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>BMI Score</label>
                        <div class="field-wrapper">
                            <input type="number" id="bmi" step="0.01" class="form-input" placeholder="00.0">
                            <i class="fas fa-weight"></i>
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <div class="section-head">
                    <div class="sec-badge" style="background:#eff6ff; color:var(--accent);"><i class="fas fa-heartbeat"></i></div>
                    <span class="sec-title">Indikator Medis</span>
                </div>

                <div class="input-group">
                    <label>Jenis Kelamin</label>
                    <div class="gender-grid">
                        <label>
                            <input type="radio" name="sex" value="male" class="gender-radio" checked>
                            <div class="gender-box">
                                <i class="fas fa-mars"></i>
                                <span>Laki-Laki</span>
                            </div>
                        </label>
                        <label>
                            <input type="radio" name="sex" value="female" class="gender-radio">
                            <div class="gender-box">
                                <i class="fas fa-venus"></i>
                                <span>Perempuan</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                    <div class="input-group">
                        <label>Jml. Anak</label>
                        <div class="field-wrapper">
                            <input type="number" id="children" class="form-input" value="0">
                            <i class="fas fa-baby"></i>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Wilayah</label>
                        <div class="field-wrapper">
                            <select id="region" class="form-input">
                                <option value="southeast">Southeast</option>
                                <option value="southwest">Southwest</option>
                                <option value="northeast">Northeast</option>
                                <option value="northwest">Northwest</option>
                            </select>
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                </div>

                <div class="input-group" style="margin-top: 10px;">
                    <div class="toggle-wrapper">
                        <div class="toggle-info">
                            <i class="fas fa-smoking"></i> Perokok Aktif?
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="smoker">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="action-row">
                    <button type="button" class="btn-reset" onclick="formManager.reset()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn-main btn-secondary" onclick="formManager.submit(false)">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                        <button type="button" class="btn-main" onclick="formManager.submit(true)">
                            <i class="fas fa-folder-plus"></i> Simpan & Baru
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    // --- 1. OPTIMIZED BACKGROUND ANIMATION ---
    const canvas = document.getElementById('form-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    // Config: Lebih sedikit partikel, gerak lebih lambat agar elegan
    const particleCount = 25; 
    let particles = [];

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Particle {
        constructor() {
            this.reset();
        }
        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 4 + 1; // Ukuran bervariasi
            this.speedX = (Math.random() - 0.5) * 0.3; // Sangat lambat
            this.speedY = (Math.random() - 0.5) * 0.3;
            this.alpha = Math.random() * 0.5 + 0.1;
        }
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.x < 0 || this.x > width || this.y < 0 || this.y > height) this.reset();
        }
        draw() {
            ctx.fillStyle = `rgba(16, 185, 129, ${this.alpha})`; // Warna Emerald transparan
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    for(let i=0; i<particleCount; i++) particles.push(new Particle());

    function animate() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
    }
    animate();

    // --- 2. FORM LOGIC (Sama seperti sebelumnya, hanya styling SweetAlert disesuaikan) ---
    class FormManager {
        constructor() {
            this.form = document.getElementById('patientForm');
        }

        validate() {
            const age = document.getElementById('age').value;
            const bmi = document.getElementById('bmi').value;
            
            if(!age || age < 0 || age > 120) {
                Swal.fire({ 
                    icon: 'warning', 
                    title: 'Usia Tidak Valid', 
                    text: 'Mohon masukkan usia antara 0 - 120 tahun.',
                    confirmButtonColor: '#059669'
                });
                return false;
            }
            if(!bmi || bmi < 10 || bmi > 100) {
                Swal.fire({ 
                    icon: 'warning', 
                    title: 'BMI Tidak Valid', 
                    text: 'Mohon masukkan BMI yang realistis (10-100).',
                    confirmButtonColor: '#059669'
                });
                return false;
            }
            return true;
        }

        async submit(addAnother) {
            if(!this.validate()) return;

            const payload = {
                name: document.getElementById('name').value || "Walk-In Patient",
                age: document.getElementById('age').value,
                bmi: document.getElementById('bmi').value,
                children: document.getElementById('children').value,
                region: document.getElementById('region').value,
                sex: document.querySelector('input[name="sex"]:checked').value,
                smoker: document.getElementById('smoker').checked ? 'yes' : 'no'
            };

            // Loading state
            Swal.fire({ 
                title: 'Menyimpan Data...', 
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading() 
            });

            try {
                // Simulasi API Call (Ganti URL ini dengan endpoint abang)
                const res = await fetch("/api/admin/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                if(result.error) throw new Error(result.error);

                await Swal.fire({
                    icon: 'success', 
                    title: 'Berhasil!',
                    text: 'Data pasien telah tersimpan.',
                    timer: 1500, 
                    showConfirmButton: false
                });

                if(addAnother) {
                    this.reset(true); 
                } else {
                    window.location.href = "/dataset"; 
                }

            } catch(e) {
                // Fallback untuk demo jika tidak ada backend
                console.log("Error simulation (Backend mungkin belum connect):", e);
                await Swal.fire({
                    icon: 'success', 
                    title: 'Demo Mode: Success',
                    text: 'Data valid (Backend belum terhubung).',
                    confirmButtonColor: '#059669'
                });
            }
        }

        reset(keepSettings = false) {
            if(!keepSettings) {
                this.form.reset();
                document.querySelector('input[value="male"]').checked = true;
                document.getElementById('region').value = 'southeast';
            } else {
                document.getElementById('name').value = '';
                document.getElementById('age').value = '';
                document.getElementById('bmi').value = '';
            }
        }
    }

    const formManager = new FormManager();
</script>

{% endblock %}