{% extends "layout.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/countup.js/1.9.3/countUp.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* --- SAMA SEPERTI SEBELUMNYA (Style tidak berubah) --- */
    :root {
        --font-main: 'Plus Jakarta Sans', sans-serif;
        --primary: #059669;       
        --primary-light: #10b981; 
        --primary-bg: #ecfdf5;     
        --accent: #3b82f6;        
        --accent-bg: #eff6ff;     
        --danger: #ef4444;
        --danger-bg: #fef2f2;
        --warning: #f59e0b;
        --warning-bg: #fffbeb;
        --text-dark: #1e293b;     
        --text-muted: #64748b;    
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.6);
        --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.06);
    }
    body { font-family: var(--font-main); color: var(--text-dark); }
    .admin-container {
        padding: 40px 5%;
        min-height: 100vh;
        background: radial-gradient(circle at top right, #f0fdf4, #f8fafc);
        position: relative;
    }
    .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 35px; flex-wrap: wrap; gap: 20px;
    }
    .header-text h1 { 
        font-size: 2rem; font-weight: 800; margin: 0; letter-spacing: -0.5px; 
        color: var(--text-dark); display: flex; align-items: center; gap: 12px;
    }
    .header-text h1 i { color: var(--primary); font-size: 1.8rem; }
    .header-text p { color: var(--text-muted); margin-top: 5px; font-weight: 500; }
    .header-actions { display: flex; gap: 15px; align-items: center; }
    .search-glass {
        background: white; border: 2px solid transparent;
        border-radius: 12px; padding: 10px 15px;
        display: flex; align-items: center; gap: 10px;
        width: 280px; transition: 0.3s;
        box-shadow: var(--shadow-soft);
    }
    .search-glass:focus-within { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); width: 300px; }
    .search-glass input { border: none; outline: none; width: 100%; font-family: inherit; font-weight: 500; color: var(--text-dark); }
    .search-glass i { color: #94a3b8; }
    .btn-glow {
        background: var(--primary); color: white; padding: 12px 24px;
        border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 0.95rem;
        display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.25); transition: 0.3s;
    }
    .btn-glow:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 15px 30px rgba(16, 185, 129, 0.35); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card {
        background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
        border: 1px solid white; border-radius: 16px; padding: 24px;
        position: relative; overflow: hidden;
        box-shadow: var(--shadow-soft); transition: 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
    .stat-card .icon-bg { position: absolute; top: -10px; right: -15px; font-size: 4rem; opacity: 0.08; transform: rotate(15deg); }
    .stat-info .label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 5px; }
    .stat-info h2 { font-size: 2.2rem; font-weight: 800; margin: 0; color: var(--text-dark); }
    .stat-card.emerald { border-bottom: 4px solid var(--primary); } .stat-card.emerald h2 { color: var(--primary); }
    .stat-card.blue { border-bottom: 4px solid var(--accent); } .stat-card.blue h2 { color: var(--accent); }
    .stat-card.red { border-bottom: 4px solid var(--danger); } .stat-card.red h2 { color: var(--danger); }
    .stat-card.orange { border-bottom: 4px solid var(--warning); } .stat-card.orange h2 { color: var(--warning); }
    .table-wrapper {
        background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 20px; border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-soft); padding: 5px; overflow-x: auto;
    }
    .glass-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .glass-table th { padding: 18px 25px; text-align: left; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .text-right { text-align: right !important; }
    .glass-table tbody tr { background: white; transition: 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .glass-table tbody tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    .glass-table tbody tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
    .glass-table tbody tr td { padding: 18px 25px; vertical-align: middle; border: none; }
    .glass-table tbody tr:hover { transform: scale(1.005); box-shadow: 0 10px 20px rgba(0,0,0,0.05); z-index: 10; position: relative; }
    .user-cell { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .user-avatar.male { background: var(--accent-bg); color: var(--accent); }
    .user-avatar.female { background: #fdf2f8; color: #ec4899; }
    .user-info h4 { margin: 0; font-size: 0.95rem; font-weight: 700; color: var(--text-dark); }
    .user-info span { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
    .badge.green { background: var(--primary-bg); color: var(--primary); }
    .badge.red { background: var(--danger-bg); color: var(--danger); }
    .badge.yellow { background: var(--warning-bg); color: var(--warning); }
    .btn-icon { width: 36px; height: 36px; border-radius: 10px; border: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; color: var(--text-muted); background: #f1f5f9; }
    .btn-icon:hover { background: #e2e8f0; color: var(--text-dark); }
    .btn-icon.delete:hover { background: var(--danger-bg); color: var(--danger); }
    .empty-state { padding: 60px; text-align: center; display: none; }
    .empty-icon { font-size: 3rem; color: #cbd5e1; margin-bottom: 15px; }
    .empty-state h3 { color: var(--text-dark); margin: 0 0 5px 0; font-weight: 700; }
    .empty-state p { color: var(--text-muted); font-size: 0.9rem; }
    .pagination-bar { display: flex; justify-content: flex-end; padding: 20px; gap: 8px; }
    .page-dot { min-width: 35px; height: 35px; border-radius: 10px; border: 1px solid transparent; background: white; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .page-dot:hover { color: var(--primary); border-color: var(--primary-bg); }
    .page-dot.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); }
    .page-dot:disabled { opacity: 0.5; cursor: not-allowed; }
    .fade-in-down { animation: fadeInDown 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .fade-in-up { opacity: 0; animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; animation-fill-mode: forwards; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .admin-container { padding: 20px; } .header-actions { width: 100%; flex-direction: column; } .search-glass { width: 100%; } .btn-glow { width: 100%; justify-content: center; } .user-info span { display: none; } }
</style>

<div class="admin-container">
    <div class="page-header fade-in-down">
        <div class="header-text">
            <h1><i class="fas fa-database"></i> Database Pasien</h1>
            <p>Kelola data latih dan riwayat pasien dari file CSV Anda.</p>
        </div>
        <div class="header-actions">
            <div class="search-glass">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Cari Nama, ID, atau Region...">
            </div>
            <a href="/add" class="btn-glow">
                <i class="fas fa-plus-circle"></i> Input Baru
            </a>
        </div>
    </div>

    <div class="stats-grid fade-in-up">
        <div class="stat-card emerald">
            <i class="fas fa-users icon-bg"></i>
            <div class="stat-info">
                <span class="label">Total Record</span>
                <h2 id="count-total">0</h2>
            </div>
        </div>
        <div class="stat-card blue">
            <i class="fas fa-child icon-bg"></i>
            <div class="stat-info">
                <span class="label">Rata-rata Usia</span>
                <h2 id="count-age">0</h2>
            </div>
        </div>
        <div class="stat-card red">
            <i class="fas fa-fire-alt icon-bg"></i>
            <div class="stat-info">
                <span class="label">Rasio Perokok</span>
                <h2 id="count-smoker">0%</h2>
            </div>
        </div>
        <div class="stat-card orange">
            <i class="fas fa-coins icon-bg"></i>
            <div class="stat-info">
                <span class="label">Avg. Charges</span>
                <h2 id="count-cost">$0</h2>
            </div>
        </div>
    </div>

    <div class="table-wrapper fade-in-up" style="animation-delay: 0.15s;">
        <table class="glass-table">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="30%">Identitas Pasien</th>
                    <th>Usia</th>
                    <th>BMI</th>
                    <th>Status</th>
                    <th>Wilayah</th>
                    <th class="text-right">Aksi</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
        
        <div id="loadingState" style="padding: 40px; text-align: center; color: var(--text-muted);">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p style="margin-top: 10px;">Memuat data dari CSV...</p>
        </div>

        <div id="emptyState" class="empty-state">
            <div class="empty-icon"><i class="fas fa-folder-open"></i></div>
            <h3>Data Tidak Ditemukan</h3>
            <p>Pastikan file CSV terisi atau coba kata kunci lain.</p>
        </div>

        <div class="pagination-bar" id="pagination"></div>
    </div>
</div>

<script>
class AdminDashboard {
    constructor() {
        this.data = [];
        this.filteredData = [];
        this.currentPage = 1;
        this.itemsPerPage = 8; 
        this.init();
    }

    async init() {
        await this.fetchData();
        this.setupSearch();
    }

    async fetchData() {
        const loading = document.getElementById('loadingState');
        const empty = document.getElementById('emptyState');
        
        try {
            loading.style.display = 'block';
            empty.style.display = 'none';

            // --- REAL FETCH KE BACKEND ---
            // Pastikan di app.py abang ada route '/api/dataset' yang me-return JSON dari CSV
            const res = await fetch('/api/dataset'); 
            
            if (!res.ok) throw new Error("Gagal mengambil data");

            const result = await res.json();
            
            // Antisipasi format: Langsung Array [..] atau Object { data: [..] }
            this.data = Array.isArray(result) ? result : (result.data || []);
            this.filteredData = [...this.data];
            
            loading.style.display = 'none';
            this.animateStats();
            this.renderTable();

        } catch (error) {
            console.error("Error:", error);
            loading.style.display = 'none';
            
            // Tampilkan SweetAlert error agar user tahu backend belum connect/error
            Swal.fire({ 
                icon: 'error', 
                title: 'Koneksi Error', 
                text: 'Gagal memuat data dataset. Pastikan server Flask berjalan dan file CSV tersedia.',
                confirmButtonColor: '#ef4444'
            });
        }
    }

    animateStats() {
        const total = this.data.length;
        // Hitung rata-rata usia
        const totalAge = this.data.reduce((acc, curr) => acc + parseInt(curr.age || 0), 0);
        const avgAge = total > 0 ? Math.round(totalAge / total) : 0;
        
        // Hitung rasio perokok
        const smokers = this.data.filter(i => i.smoker === 'yes').length;
        const smokerRatio = total > 0 ? ((smokers / total) * 100).toFixed(1) : 0;
        
        // Hitung rata-rata charges (jika kolom charges ada di CSV)
        const totalCharges = this.data.reduce((acc, curr) => acc + parseFloat(curr.charges || 0), 0);
        const avgCharges = total > 0 ? Math.round(totalCharges / total) : 0;

        if(window.CountUp) {
            new CountUp('count-total', total).start();
            new CountUp('count-age', avgAge).start();
            new CountUp('count-smoker', smokerRatio, { suffix: '%' }).start();
            new CountUp('count-cost', avgCharges, { prefix: '$' }).start(); 
        }
    }

    renderTable() {
        const tbody = document.getElementById('tableBody');
        const emptyState = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        
        tbody.innerHTML = '';
        
        if (this.filteredData.length === 0) {
            emptyState.style.display = 'block';
            pagination.innerHTML = '';
            return;
        }
        
        emptyState.style.display = 'none';

        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        const pageData = this.filteredData.slice(start, end);

        pageData.forEach((row, index) => {
            // Mapping Data CSV (Pastikan nama kolom CSV sesuai di sini)
            // Default ke huruf kecil (misal: 'Sex' jadi 'sex')
            const sex = (row.sex || row.gender || 'male').toLowerCase();
            const age = row.age || 0;
            const bmi = row.bmi || 0;
            const smoker = (row.smoker || 'no').toLowerCase();
            const region = row.region || '-';
            const name = row.name || `Pasien #${start + index + 1}`; // Jika di CSV tidak ada kolom nama

            const genderClass = sex === 'female' ? 'female' : 'male';
            const genderIcon = sex === 'female' ? '<i class="fas fa-venus"></i>' : '<i class="fas fa-mars"></i>';
            
            // Badge BMI
            const bmiVal = parseFloat(bmi);
            let bmiBadge = '';
            if (bmiVal < 18.5) bmiBadge = `<span class="badge yellow">Underweight (${bmiVal})</span>`;
            else if (bmiVal < 25) bmiBadge = `<span class="badge green">Normal (${bmiVal})</span>`;
            else if (bmiVal < 30) bmiBadge = `<span class="badge yellow">Overweight (${bmiVal})</span>`;
            else bmiBadge = `<span class="badge red">Obesitas (${bmiVal})</span>`;

            // Badge Smoker
            const smokerBadge = smoker === 'yes' 
                ? '<span class="badge red"><i class="fas fa-smoking"></i> Perokok</span>' 
                : '<span class="badge green"><i class="fas fa-leaf"></i> Non-Smoker</span>';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="color:var(--text-muted); font-weight:600;">${start + index + 1}</td>
                <td>
                    <div class="user-cell">
                        <div class="user-avatar ${genderClass}">${genderIcon}</div>
                        <div class="user-info">
                            <h4>${name}</h4>
                            <span>ID: #${1000 + start + index}</span>
                        </div>
                    </div>
                </td>
                <td style="font-weight:600; color:var(--text-dark);">${age} Th</td>
                <td>${bmiBadge}</td>
                <td>${smokerBadge}</td>
                <td style="text-transform: capitalize; color:var(--text-muted); font-weight:500;">${region}</td>
                <td class="text-right">
                    <button class="btn-icon delete" title="Hapus" onclick="dashboard.deleteItem(${start + index})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            
            tr.style.opacity = '0';
            tr.style.animation = `fadeInUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards ${index * 0.05}s`;
            tbody.appendChild(tr);
        });

        this.renderPagination();
    }

    renderPagination() {
        const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        pagination.innerHTML += `<button class="page-dot" onclick="dashboard.changePage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>`;

        for(let i = 1; i <= totalPages; i++) {
             if (i === 1 || i === totalPages || (i >= this.currentPage - 1 && i <= this.currentPage + 1)) {
                pagination.innerHTML += `<button class="page-dot ${i === this.currentPage ? 'active' : ''}" onclick="dashboard.changePage(${i})">${i}</button>`;
             } else if (i === this.currentPage - 2 || i === this.currentPage + 2) {
                 pagination.innerHTML += `<span style="padding:0 5px; color:#cbd5e1;">...</span>`;
             }
        }

        pagination.innerHTML += `<button class="page-dot" onclick="dashboard.changePage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>`;
    }

    changePage(page) {
        const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
        if (page < 1 || page > totalPages) return;
        this.currentPage = page;
        this.renderTable();
    }

    setupSearch() {
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            this.filteredData = this.data.filter(item => {
                // Sesuaikan field pencarian dengan kolom CSV Abang
                const nameMatch = item.name && item.name.toLowerCase().includes(term);
                const regionMatch = item.region && item.region.toLowerCase().includes(term);
                return nameMatch || regionMatch;
            });
            this.currentPage = 1;
            this.renderTable();
        });
    }

    async deleteItem(index) {
        const result = await Swal.fire({
            title: 'Hapus Data?',
            text: "Data akan dihapus permanen.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Ya, Hapus'
        });

        if (result.isConfirmed) {
            // TODO: Tambahkan Fetch Delete ke API Flask jika mau hapus dari CSV
            // const id = this.data[index].id;
            // await fetch('/api/delete/' + id, { method: 'DELETE' });

            this.data.splice(index, 1);
            this.filteredData = [...this.data];
            this.animateStats();
            this.renderTable();
            
            Swal.fire({ icon: 'success', title: 'Terhapus', timer: 1000, showConfirmButton: false });
        }
    }
}

const dashboard = new AdminDashboard();
</script>

{% endblock %}