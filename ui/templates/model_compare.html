{% extends "layout.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* --- 1.1. KONFIGURASI VARIABEL ROOT --- */
    :root {
        /* Tipografi Utama */
        --font-primary: 'Plus Jakarta Sans', sans-serif;

        /* Palet Warna Utama (Emerald Theme) */
        --color-emerald-50:  #ecfdf5;
        --color-emerald-100: #d1fae5;
        --color-emerald-200: #a7f3d0;
        --color-emerald-300: #6ee7b7;
        --color-emerald-400: #34d399;
        --color-emerald-500: #10b981;
        --color-emerald-600: #059669; /* Primary Brand */
        --color-emerald-700: #047857;
        --color-emerald-800: #065f46;
        --color-emerald-900: #064e3b;

        /* Palet Warna Netral & Status */
        --color-dark:     #0f172a;
        --color-gray:     #64748b;
        --color-light:    #f8fafc;
        --color-white:    #ffffff;
        --color-danger:   #ef4444;
        --color-warning:  #f59e0b;
        --color-info:     #3b82f6;

        /* Warna Peringkat (Medali) */
        --rank-gold:   #fbbf24;
        --rank-silver: #94a3b8;
        --rank-bronze: #b45309;

        /* Komponen UI */
        --bg-body:        #f1f5f9;
        --card-bg:        rgba(255, 255, 255, 0.95);
        --border-color:   #e2e8f0;
        --shadow-soft:    0 10px 40px -10px rgba(0,0,0,0.05);
        --shadow-hover:   0 20px 50px -10px rgba(5, 150, 105, 0.15);
        --radius-lg:      24px;
        --radius-md:      16px;
        --radius-sm:      8px;

        /* Transisi */
        --transition-fast: 0.2s ease;
        --transition-smooth: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- 1.2. GLOBAL RESET & LAYOUT --- */
    body {
        font-family: var(--font-primary);
        background-color: var(--bg-body);
        color: var(--color-dark);
        line-height: 1.6;
    }

    .arena-wrapper {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
        min-height: 85vh;
        display: flex;
        flex-direction: column;
    }

    /* --- 1.3. LOBBY SECTION (State Awal) --- */
    .lobby-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 60px 20px;
        animation: fadeIn 0.8s ease-out;
    }

    .lobby-icon-wrapper {
        position: relative;
        margin-bottom: 40px;
    }

    .lobby-icon-bg {
        width: 120px;
        height: 120px;
        background: var(--color-emerald-50);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse-soft 3s infinite;
    }

    .lobby-icon {
        font-size: 4rem;
        color: var(--color-emerald-600);
        filter: drop-shadow(0 4px 6px rgba(5, 150, 105, 0.3));
    }

    .lobby-title {
        font-size: 3rem;
        font-weight: 900;
        letter-spacing: -1px;
        color: var(--color-dark);
        margin-bottom: 16px;
    }

    .lobby-subtitle {
        font-size: 1.2rem;
        color: var(--color-gray);
        max-width: 650px;
        margin: 0 auto 50px auto;
        line-height: 1.7;
    }

    /* Tombol Start Battle */
    .btn-battle-start {
        position: relative;
        padding: 20px 50px;
        background: linear-gradient(135deg, var(--color-emerald-600) 0%, var(--color-emerald-500) 100%);
        color: white;
        font-size: 1.25rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 15px 30px -5px rgba(5, 150, 105, 0.4);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 15px;
    }

    .btn-battle-start:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 20px 40px -5px rgba(5, 150, 105, 0.5);
    }

    .btn-battle-start:active {
        transform: scale(0.98);
    }

    .btn-battle-start::after {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: 0.5s;
    }

    .btn-battle-start:hover::after {
        left: 100%;
    }

    /* --- 1.4. LOADING STATE --- */
    .loading-container {
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        animation: fadeIn 0.5s ease;
    }

    .loader-ring {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
        margin-bottom: 30px;
    }
    .loader-ring div {
        box-sizing: border-box;
        display: block;
        position: absolute;
        width: 64px;
        height: 64px;
        margin: 8px;
        border: 6px solid var(--color-emerald-500);
        border-radius: 50%;
        animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        border-color: var(--color-emerald-500) transparent transparent transparent;
    }
    .loader-ring div:nth-child(1) { animation-delay: -0.45s; }
    .loader-ring div:nth-child(2) { animation-delay: -0.3s; }
    .loader-ring div:nth-child(3) { animation-delay: -0.15s; }

    .loading-text {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-dark);
        margin-bottom: 10px;
    }

    .loading-steps {
        font-size: 0.9rem;
        color: var(--color-gray);
        font-family: monospace;
    }

    /* --- 1.5. DASHBOARD RESULTS (Hidden by default) --- */
    .dashboard-container {
        display: none;
        animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        padding-bottom: 50px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .btn-reset {
        background: white;
        border: 2px solid var(--border-color);
        color: var(--color-gray);
        font-weight: 700;
        padding: 10px 24px;
        border-radius: 12px;
        cursor: pointer;
        display: flex; align-items: center; gap: 8px;
        transition: var(--transition-fast);
    }
    .btn-reset:hover {
        border-color: var(--color-emerald-500);
        color: var(--color-emerald-600);
        background: var(--color-emerald-50);
    }

    /* Kartu Kaca (Glass Card) Global */
    .glass-panel {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid white;
        border-radius: var(--radius-lg);
        padding: 30px;
        box-shadow: var(--shadow-soft);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    /* --- 1.6. CHAMPION CARD (Highlight Winner) --- */
    .champion-panel {
        background: radial-gradient(circle at top right, var(--color-emerald-700), var(--color-emerald-900));
        color: white;
        text-align: center;
        padding: 50px 30px;
        border: none;
        box-shadow: 0 20px 50px -10px rgba(6, 78, 59, 0.4);
    }

    /* Pattern Background Overlay */
    .champion-panel::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 30px 30px;
        opacity: 0.3;
        pointer-events: none;
    }

    .crown-wrapper {
        margin-bottom: 20px;
        animation: float-crown 3s ease-in-out infinite;
    }
    .crown-icon {
        font-size: 4.5rem;
        color: var(--rank-gold);
        filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.6));
    }

    .champion-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 3px;
        opacity: 0.8;
        margin-bottom: 10px;
    }

    .champion-name {
        font-size: 3.5rem;
        font-weight: 900;
        margin-bottom: 20px;
        text-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .champion-stats {
        display: inline-flex;
        gap: 30px;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px 30px;
        border-radius: 50px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stat-box { display: flex; flex-direction: column; }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--rank-gold); }
    .stat-lbl { font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }

    /* --- 1.7. GRID LAYOUT (Chart & Sidebar) --- */
    .analytics-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 30px;
    }

    .sidebar-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--color-gray);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 20px;
    }

    /* Rank Cards Small */
    .rank-mini-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 15px;
        border-radius: var(--radius-md);
        margin-bottom: 15px;
        border-left: 4px solid transparent;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        transition: transform 0.2s;
    }
    .rank-mini-card:hover { transform: translateX(5px); }

    .rank-mini-card.r2 { border-left-color: var(--rank-silver); background: #f8fafc; }
    .rank-mini-card.r3 { border-left-color: var(--rank-bronze); background: #fff7ed; }

    .rank-badge-mini {
        width: 30px; height: 30px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; color: white; margin-right: 12px;
        font-size: 0.8rem;
    }

    /* Chart Area */
    .chart-header {
        display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
    }
    .chart-wrapper {
        position: relative;
        height: 350px;
        width: 100%;
    }

    /* --- 1.8. DATA TABLE --- */
    .table-container {
        overflow-x: auto;
        border-radius: var(--radius-md);
    }
    
    table.arena-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    table.arena-table th {
        background: var(--color-emerald-50);
        padding: 16px;
        text-align: left;
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--color-emerald-800);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--color-emerald-100);
    }

    table.arena-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
        color: var(--color-dark);
        font-weight: 500;
    }

    table.arena-table tr:hover td {
        background-color: #f8fafc;
    }

    /* Badges in Table */
    .badge-status {
        padding: 6px 12px;
        border-radius: 30px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .badge-win { background: #dcfce7; color: var(--color-emerald-700); }
    .badge-run { background: #f1f5f9; color: var(--color-gray); }

    /* --- 1.9. GLOSSARY SECTION --- */
    .glossary-section {
        margin-top: 50px;
        border-top: 1px solid var(--border-color);
        padding-top: 40px;
    }
    
    .glossary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .term-card {
        background: white;
        padding: 20px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
    }
    .term-title { font-weight: 700; color: var(--color-emerald-600); margin-bottom: 8px; font-size: 0.9rem; }
    .term-desc { font-size: 0.85rem; color: var(--color-gray); line-height: 1.5; }

    /* --- 1.10. ANIMATION KEYFRAMES --- */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-soft { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes float-crown { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(2deg); } }
    @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- 1.11. RESPONSIVE --- */
    @media (max-width: 1024px) {
        .analytics-grid { grid-template-columns: 1fr; }
        .champion-name { font-size: 2.5rem; }
    }
</style>


<div class="arena-wrapper">

    <div id="lobbySection" class="lobby-container">
        <div class="lobby-icon-wrapper">
            <div class="lobby-icon-bg">
                <i class="fas fa-chess-king lobby-icon"></i>
            </div>
        </div>
        
        <h1 class="lobby-title">Arena Perbandingan Model</h1>
        <p class="lobby-subtitle">
            Selamat datang di Arena. Di sini, algoritma Machine Learning akan diadu secara real-time.
            Sistem akan melatih <strong>Linear Regression, Random Forest,</strong> dan <strong>Gradient Boosting</strong> 
            menggunakan dataset Anda saat ini, lalu membandingkan akurasi (R²) dan kecepatan eksekusi mereka.
        </p>

        <button onclick="ArenaController.startBattle()" class="btn-battle-start">
            <i class="fas fa-play"></i> Mulai Pertarungan
        </button>

        <div style="margin-top: 30px; font-size: 0.9rem; color: var(--color-gray);">
            <i class="fas fa-info-circle"></i> Membutuhkan dataset minimal 50 baris untuk hasil optimal.
        </div>
    </div>


    <div id="loadingSection" class="loading-container">
        <div class="loader-ring"><div></div><div></div><div></div><div></div></div>
        <div class="loading-text">Sedang Melatih Model...</div>
        <div class="loading-steps" id="loadingStepText">
            > Initializing Data Preprocessing...<br>
            > Training Linear Regression...<br>
            > Training Ensemble Models...
        </div>
    </div>


    <div id="resultDashboard" class="dashboard-container">
        
        <div class="dashboard-header">
            <div>
                <h2 style="margin:0; font-weight:800; color:var(--color-dark);">Hasil Pertarungan</h2>
                <span style="font-size:0.9rem; color:var(--color-gray);">Analisis performa algoritma regresi</span>
            </div>
            <button onclick="ArenaController.reset()" class="btn-reset">
                <i class="fas fa-redo-alt"></i> Reset Arena
            </button>
        </div>

        <div class="glass-panel champion-panel">
            <div class="crown-wrapper">
                <i class="fas fa-crown crown-icon"></i>
            </div>
            <div class="champion-label">The Undisputed Champion</div>
            <div class="champion-name" id="heroName">Loading...</div>
            
            <div class="champion-stats">
                <div class="stat-box">
                    <span class="stat-val" id="heroScore">0%</span>
                    <span class="stat-lbl">Akurasi (R²)</span>
                </div>
                <div style="width:1px; background:rgba(255,255,255,0.3); margin:0 15px;"></div>
                <div class="stat-box">
                    <span class="stat-val" id="heroRmse" style="color:white;">0.00</span>
                    <span class="stat-lbl">Error (RMSE)</span>
                </div>
                <div style="width:1px; background:rgba(255,255,255,0.3); margin:0 15px;"></div>
                <div class="stat-box">
                    <span class="stat-val" id="heroTime" style="color:#a7f3d0;">0s</span>
                    <span class="stat-lbl">Speed</span>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            
            <div class="glass-panel">
                <div class="sidebar-title">Runner Ups (Top 3)</div>
                <div id="runnersUpContainer">
                    </div>
                
                <div style="margin-top: 30px; padding: 15px; background: #f8fafc; border-radius: 12px; font-size: 0.85rem; color: var(--color-gray);">
                    <i class="fas fa-lightbulb" style="color: var(--color-warning);"></i> <strong>Insight:</strong>
                    Model juara dipilih berdasarkan skor R² tertinggi. Namun, perhatikan waktu eksekusi jika Anda membutuhkan prediksi real-time.
                </div>
            </div>

            <div class="glass-panel">
                <div class="chart-header">
                    <div style="width: 40px; height: 40px; background: var(--color-emerald-50); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--color-emerald-600);">
                        <i class="fas fa-chart-scatter"></i>
                    </div>
                    <div>
                        <h3 style="margin:0; font-size: 1.1rem; font-weight: 700;">Efficiency Matrix</h3>
                        <span style="font-size: 0.8rem; color: var(--color-gray);">Speed (X) vs Accuracy (Y)</span>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="arenaChart"></canvas>
                </div>
            </div>

        </div>

        <div class="glass-panel">
            <h3 style="margin:0 0 20px 0; font-weight: 700;">Leaderboard Lengkap</h3>
            <div class="table-container">
                <table class="arena-table" id="fullTable">
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th>Algoritma Model</th>
                            <th>R² Score (Akurasi)</th>
                            <th>RMSE (Error Rate)</th>
                            <th>MAE (Mean Error)</th>
                            <th>Waktu Training</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="glossary-section">
            <h3 style="margin-bottom: 20px; font-weight: 700; color: var(--color-gray);">Panduan Metrik Evaluasi</h3>
            <div class="glossary-grid">
                <div class="term-card">
                    <div class="term-title">R² Score (R-Squared)</div>
                    <div class="term-desc">
                        Persentase variasi data yang bisa dijelaskan oleh model. Nilai 1 (100%) berarti sempurna. Nilai di atas 0.7 (70%) dianggap baik.
                    </div>
                </div>
                <div class="term-card">
                    <div class="term-title">RMSE (Root Mean Sq. Error)</div>
                    <div class="term-desc">
                        Rata-rata kesalahan prediksi dalam satuan asli (Dolar). Semakin KECIL nilai ini, semakin akurat prediksi biayanya.
                    </div>
                </div>
                <div class="term-card">
                    <div class="term-title">Training Time</div>
                    <div class="term-desc">
                        Waktu yang dibutuhkan CPU untuk mempelajari pola data. Algoritma kompleks (seperti Random Forest) biasanya lebih lambat.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="glossary-section" id="historySection" style="display:none;">
            <h3 style="margin-bottom: 20px; font-weight: 700; color: var(--color-gray);">Riwayat Sesi Ini</h3>
            <div class="table-container">
                <table class="arena-table">
                    <thead><tr><th>Waktu</th><th>Juara</th><th>Skor</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
/**
 * ArenaController Object
 * Mengelola semua logika halaman ini.
 */
const ArenaController = {
    // URL API Backend (Pastikan route ini ada di Flask/Python)
    API_URL: '/api/compare/run', 
    chartInstance: null,
    history: [],

    /**
     * Memulai proses battle.
     * Mengubah UI ke loading dan memanggil API.
     */
    startBattle: async function() {
        // UI Update
        document.getElementById('lobbySection').style.display = 'none';
        document.getElementById('resultDashboard').style.display = 'none';
        document.getElementById('loadingSection').style.display = 'flex';

        // Simulate progress text
        this.animateLoadingText();

        try {
            // Panggil API
            const response = await fetch(this.API_URL);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || "Gagal menghubungi server AI.");
            }

            if (data.error) {
                // Handle spesifik error dataset kosong
                if(data.error.includes("dataset")) {
                    throw new Error("Dataset kosong atau tidak cukup. Silakan upload data CSV terlebih dahulu di menu Dataset.");
                }
                throw new Error(data.error);
            }

            // Validasi data
            if (!data.leaderboard || data.leaderboard.length === 0) {
                throw new Error("Model berhasil dijalankan namun tidak ada hasil yang dikembalikan.");
            }

            // Simpan ke history session
            this.saveHistory(data.leaderboard[0]);

            // Render Hasil dengan delay sedikit agar loading terasa natural
            setTimeout(() => {
                this.renderResults(data);
            }, 800);

        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Terjadi Kesalahan',
                text: err.message,
                confirmButtonColor: '#059669',
                confirmButtonText: 'Kembali ke Lobby'
            }).then(() => {
                this.reset();
            });
        }
    },

    /**
     * Mengembalikan UI ke posisi awal
     */
    reset: function() {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('resultDashboard').style.display = 'none';
        document.getElementById('lobbySection').style.display = 'flex'; // Flex agar centering jalan
        
        // Bersihkan chart untuk mencegah memory leak
        if(this.chartInstance) {
            this.chartInstance.destroy();
            this.chartInstance = null;
        }
    },

    /**
     * Fungsi Utama Render Data ke HTML
     */
    renderResults: function(data) {
        // Hide Loading, Show Dashboard
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('resultDashboard').style.display = 'block';

        const models = data.leaderboard;
        const champion = models[0];

        // 1. Render Champion Hero Card
        document.getElementById('heroName').innerText = champion.model;
        document.getElementById('heroScore').innerText = this.formatPercent(champion.r2);
        document.getElementById('heroRmse').innerText = champion.rmse.toFixed(4);
        document.getElementById('heroTime').innerText = champion.time + "s";

        // 2. Render Sidebar Runner Ups (Model ke 2 dan 3)
        const runnersContainer = document.getElementById('runnersUpContainer');
        runnersContainer.innerHTML = '';
        
        const runners = models.slice(1, 3); // Ambil index 1 dan 2
        if (runners.length === 0) {
            runnersContainer.innerHTML = '<div style="text-align:center; color:#94a3b8;">Tidak ada model lain untuk dibandingkan.</div>';
        }

        runners.forEach((m, index) => {
            const realRank = index + 2;
            const rankColor = realRank === 2 ? '#94a3b8' : '#b45309'; // Silver / Bronze
            const rankClass = realRank === 2 ? 'r2' : 'r3';
            
            const html = `
                <div class="rank-mini-card ${rankClass}">
                    <div style="display:flex; align-items:center;">
                        <div class="rank-badge-mini" style="background:${rankColor}">${realRank}</div>
                        <div>
                            <div style="font-weight:700; color:var(--color-dark);">${m.model}</div>
                            <div style="font-size:0.8rem; color:var(--color-gray);">Time: ${m.time}s</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:700; color:var(--color-emerald-600);">${this.formatPercent(m.r2)}</div>
                        <div style="font-size:0.75rem; color:var(--color-gray);">Acc</div>
                    </div>
                </div>
            `;
            runnersContainer.innerHTML += html;
        });

        // 3. Render Tabel Lengkap
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        models.forEach((m, index) => {
            const rank = index + 1;
            const isWinner = rank === 1;
            const badgeClass = isWinner ? 'badge-win' : 'badge-run';
            const badgeText = isWinner ? 'WINNER' : 'COMPLETED';
            
            // Format MAE jika ada, jika tidak pakai dash
            const maeVal = m.mae ? m.mae.toFixed(4) : '-';

            const row = `
                <tr>
                    <td><span style="font-weight:700; color:var(--color-gray);">${rank}</span></td>
                    <td>
                        <strong>${m.model}</strong>
                        ${isWinner ? '<i class="fas fa-trophy" style="color:var(--rank-gold); margin-left:5px;"></i>' : ''}
                    </td>
                    <td style="color:var(--color-emerald-600); font-weight:700;">${this.formatPercent(m.r2)}</td>
                    <td>${m.rmse.toFixed(4)}</td>
                    <td>${maeVal}</td>
                    <td style="font-family:monospace;">${m.time}s</td>
                    <td><span class="badge-status ${badgeClass}">${badgeText}</span></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // 4. Render Chart.js
        this.renderChart(models);

        // 5. Render History (Jika ada)
        this.renderHistory();
        
        // Scroll ke atas
        window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    /**
     * Konfigurasi dan Render Scatter Plot dengan Chart.js
     */
    renderChart: function(models) {
        const ctx = document.getElementById('arenaChart').getContext('2d');
        
        if (this.chartInstance) {
            this.chartInstance.destroy();
        }

        // Data Transformation untuk Scatter Plot
        // X: Speed (Time), Y: Accuracy (R2)
        const plotData = models.map(m => ({
            x: parseFloat(m.time), 
            y: m.r2,
            model: m.model
        }));

        this.chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Model Efficiency',
                    data: plotData,
                    backgroundColor: (context) => {
                        // Highlight Champion dengan warna Emas
                        const raw = context.raw;
                        return (raw && raw.model === models[0].model) ? '#fbbf24' : '#10b981';
                    },
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const pt = context.raw;
                                return `${pt.model}: Acc ${(pt.y*100).toFixed(1)}% | Time ${pt.x}s`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: { display: true, text: 'Waktu Eksekusi (Detik) - Semakin Kiri Semakin Baik' },
                        grid: { color: '#f1f5f9' }
                    },
                    y: {
                        title: { display: true, text: 'Akurasi (R²) - Semakin Atas Semakin Baik' },
                        grid: { color: '#f1f5f9' },
                        min: 0
                    }
                }
            }
        });
    },

    /**
     * Utilitas Formatter Persentase
     */
    formatPercent: function(val) {
        let num = parseFloat(val);
        // Jika API kirim desimal (0.98), jadikan 98.0
        // Jika API kirim persen (98.0), biarkan
        if (num <= 1 && num > -1) num = num * 100;
        return num.toFixed(2) + '%';
    },

    /**
     * Efek teks loading berganti-ganti
     */
    animateLoadingText: function() {
        const el = document.getElementById('loadingStepText');
        const steps = [
            "> Reading Dataset...",
            "> Preprocessing Data...",
            "> Training Linear Regression...",
            "> Training Random Forest...",
            "> Calculating Error Metrics...",
            "> Finalizing Leaderboard..."
        ];
        let i = 0;
        const interval = setInterval(() => {
            if (document.getElementById('loadingSection').style.display === 'none') {
                clearInterval(interval);
                return;
            }
            el.innerHTML += "<br>" + steps[i % steps.length];
            i++;
            // Keep only last 3 lines
            const lines = el.innerHTML.split("<br>");
            if (lines.length > 4) {
                el.innerHTML = lines.slice(lines.length - 4).join("<br>");
            }
        }, 800);
    },

    /**
     * History Management (Session)
     */
    saveHistory: function(winner) {
        const now = new Date().toLocaleTimeString();
        this.history.push({ time: now, model: winner.model, score: winner.r2 });
    },

    renderHistory: function() {
        if (this.history.length === 0) return;
        
        document.getElementById('historySection').style.display = 'block';
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = ''; // Clear old, rebuild list
        
        // Show last 5
        [...this.history].reverse().slice(0, 5).forEach(h => {
            tbody.innerHTML += `
                <tr>
                    <td style="color:var(--color-gray); font-size:0.85rem;">${h.time}</td>
                    <td style="font-weight:600;">${h.model}</td>
                    <td style="color:var(--color-emerald-600); font-weight:700;">${this.formatPercent(h.score)}</td>
                </tr>
            `;
        });
    }
};
</script>

{% endblock %}